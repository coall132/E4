{% extends "base.html" %}
{% set ACTIVE = "login" %}

{% block content %}
<h1 class="mb-4">Connexion</h1>
<form id="login-form" class="needs-validation" novalidate>
  <div class="mb-3">
    <label for="username" class="form-label">Nom d'utilisateur</label>
    <input type="text" id="username" name="username" class="form-control" placeholder="Votre nom d'utilisateur" required>
    <div class="invalid-feedback">
      Veuillez renseigner un nom d'utilisateur.
    </div>
  </div>
  <div class="mb-3">
    <label for="password" class="form-label">Mot de passe</label>
    <input type="password" id="password" name="password" class="form-control" placeholder="Votre mot de passe" required>
    <div class="invalid-feedback">
      Veuillez renseigner un mot de passe.
    </div>
  </div>
  <button type="submit" class="btn btn-primary w-100">Se connecter</button>
  <p class="mt-3 text-center">Pas encore de compte ? <a href="/register">Créer un compte</a></p>
  <div id="login-msg" class="alert mt-3 d-none" role="alert"></div>
</form>
{% endblock %}

{% block scripts %}
<script>
// Validation Bootstrap (empêche l'envoi si des champs sont vides)
(() => {
  'use strict';
  const forms = document.querySelectorAll('.needs-validation');
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });
})();

function showMsg(text, type="info") {
  const box = document.getElementById('login-msg');
  box.classList.remove('d-none', 'alert-info', 'alert-success', 'alert-danger', 'alert-warning');
  box.classList.add('alert', `alert-${type}`);
  box.textContent = text;
}

function getQueryParam(name) {
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}

const form = document.getElementById('login-form');
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!form.checkValidity()) return;

  showMsg('Connexion…', 'info');

  const formData = new FormData(form);
  const username = formData.get('username');
  const password = formData.get('password');

  try {
    const response = await fetch('/auth/web/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ username, password })
    });

    if (!response.ok) {
      if (response.status === 401) throw new Error("Nom d'utilisateur ou mot de passe incorrect.");
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    const token = data.access_token;
    if (!token) throw new Error("Réponse invalide du serveur : access_token manquant.");

    // 1) Garder pour vos appels fetch côté client
    localStorage.setItem('ACCESS_TOKEN', token);

    // 2) Cookie lisible par le serveur pour vos pages HTML
    //    - Path=/ pour toutes les routes
    //    - Max-Age (fallback 86400s si expires_at absent)
    //    - SameSite=Lax pour éviter des soucis de navigation
    const maxAge = data.expires_at ? Math.max(1, Math.floor(data.expires_at - (Date.now()/1000))) : 86400;
    document.cookie = `ACCESS_TOKEN=${token}; Path=/; Max-Age=${maxAge}; SameSite=Lax`;

    showMsg('Connecté ! Redirection…', 'success');

    // Redirection vers ?next=… si présent, sinon accueil
    const next = getQueryParam('next') || '/';
    window.location.href = "/";

  } catch (err) {
    showMsg(`Erreur : ${err.message}`, 'danger');
  }
});
</script>
{% endblock %}
