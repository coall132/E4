{% extends "base.html" %}
{% set ACTIVE = "login" %}
{% block content %}
<div class="container" style="max-width:600px">
  <h2 class="mb-4">Connexion</h2>
  <p class="text-muted">Collez votre clé API (au format <code>rk_xxx.yyyy</code>) pour obtenir un token.</p>
  <form id="login-form" class="vstack gap-3">
    <input class="form-control form-control-lg" name="api_key" placeholder="rk_xxx.yyyy" required>
    <button class="btn btn-primary btn-lg" type="submit">Se connecter</button>
    <div id="login-msg" class="small text-muted"></div>
  </form>
</div>
{% endblock %}
{% block scripts %}
<script>
const form = document.getElementById('login-form');
const msg  = document.getElementById('login-msg');
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  msg.textContent = 'Connexion…';
  const apiKey = new FormData(form).get('api_key');
  try {
    const r = await fetch('/auth/token', {
      method:'POST',
      headers:{'X-API-KEY': apiKey}
    });
    if(!r.ok) throw new Error('HTTP ' + r.status);
    const data = await r.json();
    localStorage.setItem('API_KEY', apiKey);
    localStorage.setItem('ACCESS_TOKEN', data.access_token);
    msg.textContent = 'Connecté ! Vous pouvez retourner à l’accueil.';
    window.location.href = '/';
  } catch(err) {
    msg.textContent = 'Erreur : ' + err;
  }
});
</script>
{% endblock %}
