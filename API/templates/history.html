{% extends "base.html" %}

{% block content %}
<div class="container section-title" data-aos="fade-up">
    <h2>Votre Historique de Recommandations</h2>
    <p>Retrouvez ici toutes vos recherches pr√©c√©dentes et les restaurants que nous vous avons sugg√©r√©s.</p>
</div>

<div id="history-container" class="accordion">
    <div class="text-center p-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    if (!getToken()) {
        window.location.href = '/login';
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const container = document.getElementById('history-container');
        try {
            const response = await fetch('/predictions/me', {
                headers: {'Authorization': `Bearer ${getToken()}`}
            });
            if (!response.ok) throw new Error('Impossible de charger l\'historique.');

            const predictions = await response.json();
            
            if (predictions.length === 0) {
                 container.innerHTML = '<div class="alert alert-secondary border-0">Vous n\'avez pas encore de pr√©dictions.</div>';
                 return;
            }

            container.innerHTML = ''; // Vider le spinner
            predictions.forEach((pred, index) => {
                const date = new Date(pred.form.created_at).toLocaleString('fr-FR');
                
                // Construire le r√©sum√© de la recherche
                let criteria = [];
                if(pred.form.description) criteria.push(`"${pred.form.description}"`);
                if(pred.form.city) criteria.push(`üìç ${pred.form.city}`);
                if(pred.form.price_level) criteria.push(`üí∞ ${'‚Ç¨'.repeat(pred.form.price_level)}`);
                const criteriaHtml = criteria.length > 0 ? `<strong>Crit√®res :</strong> ${criteria.join(' ‚Ä¢ ')}` : 'Aucun crit√®re sp√©cifique.';

                // Construire la liste des r√©sultats
                let itemsHtml = '';
                pred.items_rich.forEach(item => {
                    itemsHtml += `<li class="list-group-item bg-transparent border-secondary">${item.details.nom} <span class="badge bg-primary float-end">Score: ${item.score.toFixed(2)}</span></li>`;
                });

                const accordionItem = `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-${index}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${index}">
                                Recherche du ${date}
                            </button>
                        </h2>
                        <div id="collapse-${index}" class="accordion-collapse collapse" data-bs-parent="#history-container">
                            <div class="accordion-body">
                                <p>${criteriaHtml}</p>
                                <h6>Restaurants sugg√©r√©s :</h6>
                                <ul class="list-group list-group-flush">${itemsHtml}</ul>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', accordionItem);
            });

        } catch (err) {
            container.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
        }
    });
</script>
{% endblock %}