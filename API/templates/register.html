{% extends "base.html" %}
{% set ACTIVE = "register" %}
{% block content %}
<section class="section py-4">
  <div class="container" style="max-width:680px">
    <h3 class="mb-3">Créer une clé API</h3>
    <form id="reg-form" class="row g-3">
      <div class="col-md-6"><label class="form-label">Email</label><input class="form-control" name="email" required></div>
      <div class="col-md-6"><label class="form-label">Username</label><input class="form-control" name="username" required></div>
      <div class="col-12"><label class="form-label">Admin password (serveur)</label><input class="form-control" name="admin" placeholder="coall" required></div>
      <div class="col-12 d-grid"><button class="btn btn-primary">Créer</button></div>
      <div class="col-12"><pre id="reg-out" class="bg-light p-3 rounded small mb-0"></pre></div>
    </form>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
const form = document.getElementById('reg-form');
const out  = document.getElementById('reg-out');
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  out.textContent = '…';
  const fd = new FormData(form);
  try {
    const r = await fetch('/auth/api-keys?password=' + encodeURIComponent(fd.get('admin')), {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ email: fd.get('email'), username: fd.get('username') })
    });
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const data = await r.json();
    out.textContent = JSON.stringify(data, null, 2);
    localStorage.setItem('API_KEY', data.api_key);
  } catch (err) { out.textContent = 'Erreur: ' + err; }
});
</script>
{% endblock %}
